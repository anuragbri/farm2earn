<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Farm2Earn ‚Äî Play</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06060a; --card:#0f1114; --muted:#9aa3b2; --gold:#f6c94b;
  --accent:#7ef2b3; --glass: rgba(255,255,255,0.03);
  --success:#4caf50; --error:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0; font-family:Inter,system-ui,Arial; background:
  radial-gradient(800px 400px at 10% 10%, rgba(246,201,75,0.04), transparent),
  linear-gradient(180deg,#05050a,#0b0b0d); color:#e9eef8; -webkit-font-smoothing:antialiased}
.app{max-width:1100px;margin:28px auto;padding:18px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--gold),#ffd86b);display:flex;align-items:center;justify-content:center;color:#111;font-weight:800;font-size:20px;box-shadow:0 8px 30px rgba(246,201,75,0.08)}
h1{margin:0;font-size:18px}
.top-stats{display:flex;gap:10px;align-items:center}
.stat{background:var(--card);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
.actions{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
.btn.gold{background:linear-gradient(90deg,var(--gold),#ffd86b);color:#111;font-weight:700}
.btn.primary{background:linear-gradient(90deg,#7ef2b3,#42d3a2);color:#022; font-weight:700}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:22px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.crop-title{Display:flex;align-items:center;gap:12px}
.emoji{font-size:28px}
.small{font-size:13px;color:var(--muted)}
.controls{margin-top:12px;display:flex;gap:8px;align-items:center}
input, select{width:100%;padding:10px;border-radius:8px;border:none;background:#0b0b0f;color:#eaf0ff}
.full{grid-column: span 3}
.footer{margin-top:22px;text-align:center;color:var(--muted);font-size:13px}
.history-list{max-height:260px;overflow:auto;margin-top:12px;border-radius:10px;padding:8px;background:rgba(255,255,255,0.015)}
table{width:100%;border-collapse:collapse;color:#dbe9f7}
th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,2,2,0.6);z-index:100}
.popup{width:420px;background:linear-gradient(180deg,#0b0b0d,#0e1114);padding:18px;border-radius:12px;border:1px solid rgba(246,201,75,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.7);text-align:center}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:10px}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--gold),#ffd86b)}
.qr{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px}
.row{display:flex;gap:8px;align-items:center}
@media(max-width:980px){ .grid{grid-template-columns:1fr} .full{grid-column:span 1} .logo{display:none} header{flex-direction:column;align-items:flex-start;gap:8px} }

/* card re-style */
.card{ background:#111; padding:15px; border-radius:12px; color:#fff; margin:10px 0; display:flex; flex-direction:column; gap:10px; }
.controls input{ width:60px; padding:8px; border-radius:6px; border:none; background:#222; color:#fff; }
.btn{ padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; transition:0.18s; }
.btn.gold{ background:var(--gold); color:#000; }
.btn.gold:hover{ filter:brightness(.95); }
.btn.primary{ background:linear-gradient(90deg,#7ef2b3,#42d3a2); color:#022; }
.popup-content{ text-align:left; color:#eaf0ff; }
.popup-close{ position:absolute; right:18px; top:12px; cursor:pointer; color:#fff; font-weight:700; }
.msgBox { position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%); background: rgba(30, 30, 30, 0.9); color: #fff; padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 500; box-shadow: 0 0 10px rgba(0,0,0,0.4); opacity: 0; transition: all 0.45s ease; z-index: 9999; }
.msgBox.show { bottom: 25px; opacity: 1; }
.msgBox.success { background: linear-gradient(135deg,#3cd65b,#128d3b); color:#fff; }
.msgBox.error { background: linear-gradient(135deg,#ff5555,#c92a2a); color:#fff; }
.msgBox.info { background: linear-gradient(135deg,#f8d47e,#b89734); color:#111; }

/* streak bar override color */
.progress > i.streak { background: linear-gradient(90deg,#7ef2b3,#42d3a2); height:100%; display:block; }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo">F2</div>
      <div>
        <h1>Farm2Earn ‚Äî Play</h1>
        <div class="small">Stylish demo ‚Ä¢ Firebase live</div>
      </div>
    </div>

    <div class="top-stats">
      <div class="stat">UID: <b id="meId">‚Äî</b></div>
      <div class="stat">Balance: <b id="meBal">‚Çπ0</b></div>
      <div class="stat">Coins: <b id="meCoins">0</b></div>
      <div class="stat">Farms: <b id="meFarms">0</b></div>
      <div class="actions">
        <button class="btn" onclick="renderHeader()">Refresh</button>
        <button class="btn" id="openAdminHint" title="Admin (hidden)" style="display:none">Admin</button>
      </div>
    </div>
  </header>

  <nav style="margin-top:12px">
    <button class="btn" onclick="show('farm')">Farm</button>
    <button class="btn" onclick="show('deposit')">Deposit</button>
    <button class="btn" onclick="show('withdraw')">Withdraw</button>
    <button class="btn" onclick="show('profile')">Profile</button>
    <button class="btn gold" onclick="show('history')">History</button>
  </nav>

  <div id="farm" class="grid">
    <div class="card">
      <div class="crop-title">
        <div class="emoji">üçÖ</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Tomato ‚Äî Lot (20)</div>
          <div class="small">Cost/lot: ‚Çπ200 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="tomatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('tomato')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•ï</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Carrot ‚Äî Lot (15)</div>
          <div class="small">Cost/lot: ‚Çπ150 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="carrotLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('carrot')">Start</button>
      </div>
    </div>

    <div class="card">
      <div class="crop-title">
        <div class="emoji">ü•î</div>
        <div>
          <div style="font-weight:700;color:var(--gold)">Potato ‚Äî Lot (25)</div>
          <div class="small">Cost/lot: ‚Çπ250 ‚Ä¢ Time: 5m</div>
        </div>
      </div>
      <div class="controls">
        <input id="potatoLots" type="number" min="1" value="1">
        <button class="btn gold" onclick="openFarmPopup('potato')">Start</button>
      </div>
    </div>

    <div class="card full">
      <h3 style="margin:0;color:var(--gold)">Quick Actions</h3>
      <div class="small" style="margin-top:8px">Quick farm, deposit or check history.</div>
      <div style="margin-top:10px" class="row">
        <button class="btn primary" onclick="quickFarm50()">Quick Farm ‚Çπ50</button>
        <button class="btn" onclick="show('deposit')">Deposit</button>
        <button class="btn" onclick="show('history')">History</button>
      </div>
    </div>
  </div>

  <!-- deposit -->
  <div id="deposit" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üí≥ Deposit (UPI)</h3>
    <div class="row" style="margin-top:10px">
      <input id="depositAmt" type="number" min="1" placeholder="Amount (‚Çπ)">
      <button class="btn gold" onclick="startDeposit()">Deposit</button>
    </div>
    <div class="small" style="margin-top:10px">You will see a QR + UPI. After paying, press <b>Done</b> to send request to admin.</div>

    <div id="depositFlow" style="display:none;margin-top:12px">
      <div class="small">Send payment to:</div>
      <div style="margin-top:6px;font-weight:700;color:#cfead0" id="upiDisplay"></div>
      <div class="qr" id="qrWrap"></div>
      <div class="small" id="countdownDisplay" style="margin-top:8px"></div>
      <div style="margin-top:10px"><button class="btn gold" id="depositDoneBtn" onclick="finishDeposit()" disabled>Done</button></div>
    </div>
  </div>

  <!-- withdraw -->
  <div id="withdraw" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üè¶ Withdraw Request</h3>
    <div style="margin-top:8px" class="row">
      <input id="withdrawAmt" type="number" placeholder="Amount (‚Çπ)">
      <input id="withdrawNote" type="text" placeholder="UPI / Bank details">
      <button class="btn gold" onclick="createWithdraw()">Request</button>
    </div>
    <div class="small" style="margin-top:8px">Admin will approve and process externally.</div>
  </div>

  <!-- profile -->
  <div id="profile" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üë§ Profile</h3>

    <div style="display:flex;align-items:center;gap:15px;margin-top:10px">
      <div style="
        width:60px;height:60px;border-radius:50%;
        background:linear-gradient(135deg,#7ef2b3,#42d3a2);
        display:flex;align-items:center;justify-content:center;
        font-size:24px;font-weight:700;color:#022;
      ">
        <span id="avatarLetter">F</span>
      </div>

      <div style="line-height:1.4">
        <div style="font-size:18px;font-weight:700" id="profileSavedName">‚Äî</div>
        <div class="small">UID: <b id="profileUID">‚Äî</b></div>
        <div class="small">Joined: <b id="joinedDate">‚Äî</b></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <input id="profileName" type="text" placeholder="Your name" autocomplete="off" style="margin-bottom:8px">
      <input id="profileUPI" type="text" placeholder="Your UPI ID (optional)" style="margin-bottom:8px">
      <button class="btn gold" onclick="saveProfile()">Save Changes</button>
    </div>

    <h4 style="color:var(--gold);margin-top:15px">üî• Daily Streak</h4>
    <div class="small">
      Streak: <b id="streakCount">0</b> / 7
    </div>
    <div class="progress" style="margin-top:6px;height:14px;">
      <i id="streakBar" class="streak" style="width:0%"></i>
    </div>

    <button class="btn primary" onclick="claimDaily()" style="margin-top:12px;width:100%">
      Claim Daily Reward
    </button>

    <h4 style="color:var(--gold);margin-top:15px">üéí Inventory</h4>
    <div id="inventory" class="row"></div>

    <h4 style="color:var(--gold);margin-top:15px">üèÖ Level & Progress</h4>
    <div class="small">Level: <b id="playerLevel">0</b></div>
    <div class="progress"><i id="levelBar" style="width:0%"></i></div>
  </div>

  <!-- history -->
  <div id="history" class="card full" style="display:none;margin-top:18px">
    <h3 style="color:var(--gold)">üìú History & Requests</h3>
    <input type="text" id="searchHistory" placeholder="Search farm id / crop..." onkeyup="filterTables()" style="margin-top:8px">
    <div style="margin-top:12px">
      <h4 style="color:var(--gold)">Farms</h4>
      <div style="max-height:220px;overflow:auto"><table id="farmsTable"><thead><tr><th>ID</th><th>Crop</th><th>Lots</th><th>Status</th><th>Profit</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Deposits</h4>
      <div style="max-height:120px;overflow:auto"><table id="deposTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
      <h4 style="color:var(--gold);margin-top:10px">Withdraws</h4>
      <div style="max-height:120px;overflow:auto"><table id="withTable"><thead><tr><th>ID</th><th>Amt</th><th>Status</th></tr></thead><tbody></tbody></table></div>
    </div>

  <div class="footer">¬© 2025 Farm2Earn ‚Äî stylish demo</div>
</div>

<!-- overlay popup (generic) -->
<div class="overlay" id="overlayPopup">
  <div class="popup" id="popupBox">
    <div style="position:relative">
      <span class="popup-close" id="popupClose">‚úñ</span>
      <div class="popup-content">
        <h2 id="popupTitle"></h2>
        <div id="popupBody" style="margin-top:8px"></div>
        <div id="popupProgressWrap" style="display:none;margin-top:12px">
          <div class="progress"><i id="popupProgressBar"></i></div>
        </div>
        <div style="margin-top:12px" id="popupActions"></div>
      </div>
    </div>
  </div>
</div>

<!-- message container -->
<div id="msgContainer"></div>

<script>
/* ====== CONFIG ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDQsF4P9UmS0TZArvtvV6e_Fx3pBgNCBaY",
  authDomain: "farm2earning.firebaseapp.com",
  projectId: "farm2earning",
  storageBucket: "farm2earning.firebasestorage.app",
  messagingSenderId: "787325025832",
  appId: "1:787325025832:web:d30236c045fc5f3d7abf1d",
  measurementId: "G-LZYGJEYDQX"
};
const ADMIN_PASSWORD = 'admin123';
const UPI_ID = "praphullprakashara@axl";
const TEST_MODE = false;
const FARM_TIME_MS = TEST_MODE ? 5_000 : 5 * 60 * 1000; // 5 minutes chosen
/* ====== Firebase init (optional) ====== */
let firebaseEnabled = false;
let db = null;
try {
  if (typeof firebase !== 'undefined') {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    firebaseEnabled = true;
    console.log('Firebase init OK');
  } else {
    console.warn('Firebase SDK not found ‚Äî running with localStorage only.');
  }
} catch (e) {
  console.warn('Firebase init failed:', e);
  firebaseEnabled = false;
}

/* ====== LocalStorage helpers ====== */
function getStoreRaw(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null; } }
function getStore(k, def){ try{ const v=JSON.parse(localStorage.getItem(k)); return v ?? def; }catch(e){ return def; } }
function setStore(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* Initialize stores */
if(!getStore('users',null)) setStore('users', {});
if(!getStore('farms',null)) setStore('farms', []);
if(!getStore('deposits',null)) setStore('deposits', []);
if(!getStore('withdraws',null)) setStore('withdraws', []);

/* ====== current user creation ====== */
let currentUser = getStore('currentUser', null);
let users = getStore('users', {});
if(!currentUser){
  const uid = randomID();
  users[uid] = { 
    id: uid, 
    name: `Farmer_${uid.slice(-3)}`, 
    balance: 1000, 
    coins: 0,
    daily: { lastClaim: "", streak: 0 },
    inventory:{}, 
    stats:{farms:0,wins:0,profit:0}, 
    joined: Date.now() 
  };
  setStore('users', users);
  setStore('currentUser', uid);
  currentUser = uid;
} else if(!users[currentUser]) {
  users[currentUser] = { 
    id: currentUser, 
    name: `Farmer_${currentUser.slice(-3)}`, 
    balance: 1000, 
    coins: 0,
    daily: { lastClaim: "", streak: 0 },
    inventory:{}, 
    stats:{farms:0,wins:0,profit:0}, 
    joined: Date.now() 
  };
  setStore('users', users);
}

/* ====== Utilities ====== */
function randomID(){
  const L="ABCDEFGHIJKLMNOPQRSTUVWXYZ"; const N="0123456789";
  let id=""; for(let i=0;i<3;i++) id+=L[Math.floor(Math.random()*L.length)];
  for(let j=0;j<2;j++) id+=N[Math.floor(Math.random()*N.length)];
  return "F2E-"+id;
}
function formatAmt(a){ return "‚Çπ"+Number(a).toLocaleString("en-IN"); }
function now(){ return Date.now(); }

/* ====== Coin conversion helpers ====== */
function coinToRupee(coin){
  return coin / 100;
}
function rupeeToCoin(rs){
  return rs * 100;
}

/* ====== Crop config (S3 probabilities) ====== */
const CROP = {
  tomato: {name:'Tomato', lotSize:20, costPerLot:200, timeSec: FARM_TIME_MS/1000, returnPerItem:1600}, // chance 3%
  carrot: {name:'Carrot', lotSize:15, costPerLot:150, timeSec: FARM_TIME_MS/1000, returnPerItem:1000}, // chance 4%
  potato: {name:'Potato', lotSize:25, costPerLot:250, timeSec: FARM_TIME_MS/1000, returnPerItem:2000} // chance 2%
};

/* ====== UI Init ====== */
function renderHeader(){
  users = getStore('users', {});
  const me = users[currentUser] || { id: currentUser, name:'‚Äî', balance:0, stats:{farms:0} };
  document.getElementById('meId').innerText = me.id;
  document.getElementById('meBal').innerText = formatAmt(me.balance||0);
  document.getElementById('meFarms').innerText = me.stats?.farms||0;
  document.getElementById('meCoins').innerText = me.coins || 0;
  document.getElementById('profileUID').innerText = me.id;
  document.getElementById('profileSavedName').innerText = me.name || '‚Äî';
  document.getElementById('profileName').value = me.name || '';
  document.getElementById('profileUPI').value = me.upi || '';
  document.getElementById('profileUID').innerText = me.id;
  document.getElementById('profileSavedName').innerText = me.name || '‚Äî';
  document.getElementById('avatarLetter').innerText = (me.name?.[0] || 'F').toUpperCase();
  document.getElementById('joinedDate').innerText = me.joined ? new Date(me.joined).toLocaleDateString() : '‚Äî';

  // Streak UI
  if (me.daily) {
    const streak = me.daily.streak || 0;
    document.getElementById('streakCount').innerText = streak;
    document.getElementById('streakBar').style.width = (streak / 7) * 100 + "%";
  } else {
    document.getElementById('streakCount').innerText = 0;
    document.getElementById('streakBar').style.width = "0%";
  }

  // Level
  const farmsDone = me.stats?.farms || 0;
  const level = Math.floor(farmsDone / 20);
  document.getElementById('playerLevel').innerText = level;
  document.getElementById('levelBar').style.width = Math.min(100, (farmsDone % 20) * 5) + '%';

  renderInventory();
  renderTables();
}

function renderInventory(){
  const users = getStore('users', {});
  const me = users[currentUser] || {inventory:{}};
  const cont = document.getElementById('inventory');
  cont.innerHTML = '';
  const inv = me.inventory || {};
  if(Object.keys(inv).length === 0){ cont.innerHTML = '<div class="small">No items</div>'; return; }
  Object.entries(inv).forEach(([k,v])=>{
    const el = document.createElement('div');
    el.style.padding='6px 10px'; el.style.background='rgba(255,255,255,0.03)'; el.style.borderRadius='8px';
    el.innerHTML = `<b>${k}</b> x ${v}`;
    cont.appendChild(el);
  });
}

/* Page switch */
function show(page){
  ['farm','deposit','withdraw','profile','history'].forEach(p=>{
    const el = document.getElementById(p);
    if(!el) return;
    el.style.display = (p===page ? (p==='farm'?'grid':'block') : 'none');
  });
  if(page==='history') renderTables();
}

/* ====== Popup + Messages ====== */
const overlay = document.getElementById('overlayPopup');
const popupTitle = document.getElementById('popupTitle');
const popupBody = document.getElementById('popupBody');
const popupActions = document.getElementById('popupActions');
const popupProgWrap = document.getElementById('popupProgressWrap');
const popupProgBar = document.getElementById('popupProgressBar');

document.getElementById('popupClose').onclick = ()=>{ closePopup(); };

function openPopup(title, bodyHTML, actionsHTML = '', showProgress=false){
  popupTitle.innerText = title;
  popupBody.innerHTML = bodyHTML;
  popupActions.innerHTML = actionsHTML;
  popupProgWrap.style.display = showProgress ? 'block' : 'none';
  popupProgBar.style.width = '0%';
  overlay.style.display = 'flex';
}
function closePopup(){
  overlay.style.display = 'none';
  popupActions.innerHTML = '';
  popupBody.innerHTML = '';
  popupTitle.innerText = '';
  popupProgWrap.style.display = 'none';
  popupProgBar.style.width = '0%';
}

function showMessage(msg, type='info'){
  const box = document.createElement('div');
  box.className = `msgBox ${type}`;
  box.innerText = msg;
  document.body.appendChild(box);
  setTimeout(()=>box.classList.add('show'),50);
  setTimeout(()=>{ box.classList.remove('show'); setTimeout(()=>box.remove(),500); }, 3000);
}

/* ====== Farming flow (clean single system) ====== */
let pendingFarm = null; // store farm object before confirm

function openFarmPopup(cropKey){
  const crop = CROP[cropKey];
  const lots = Math.max(1, parseInt(document.getElementById(cropKey+'Lots').value) || 1);
  const totalCost = crop.costPerLot * lots;
  const totalQty = crop.lotSize * lots;
  const estReturn = 'Variable (random)';96
  const body = `
    <div><b>${crop.name}</b> ‚Äî ${lots} lot(s)</div>
    <div style="margin-top:8px" class="small">
      Total Quantity: <b>${totalQty}</b><br>
      Total Cost: <b>${formatAmt(totalCost)}</b><br>
      Estimated Return: <b>${estReturn}</b><br>
      Time: <b>${Math.round(FARM_TIME_MS/60000)}m</b>
    </div>
  `;
  const actions = `<button class="btn gold" id="confirmFarmBtn">Confirm & Start</button>`;
  openPopup(`Start ${crop.name}`, body, actions, false);
  document.getElementById('confirmFarmBtn').onclick = ()=>confirmStartFarm(cropKey, lots);
}

function confirmStartFarm(cropKey, lots){
  closePopup();
  startFarm(cropKey, lots);
}

function startFarm(cropKey, lots){
  const users = getStore('users', {});
  const me = users[currentUser];
  const crop = CROP[cropKey];
  const totalCost = crop.costPerLot * lots;
  if(me.balance < totalCost){ showMessage('Insufficient balance!', 'error'); return; }

  // Deduct instantly
  me.balance -= totalCost;
  users[currentUser] = me;
  setStore('users', users);

  // Create farm record
  const id = randomID();
  const start = now();
  const finish = start + FARM_TIME_MS;
  const farm = {
    id, owner: currentUser, crop: cropKey, cropName: crop.name,
    lots, lotSize: crop.lotSize, cost: totalCost, start, finish, status: 'growing'
  };

  // Save locally + firestore
  const farms = getStore('farms', []);
  farms.unshift(farm);
  setStore('farms', farms);
  if(firebaseEnabled) writeDoc('farms', id, farm);

  renderHeader(); renderTables();

  // Show progress popup with progress bar
  const body = `<div class="small">Farming in progress ‚Äî Farm ID: <b>${id}</b><br>Do not close the page.</div>`;
  const actions = `<button class="btn" onclick="closePopup()">Minimize</button>`;
  openPopup('üåæ Farming Started', body, actions, true);

  // Progress updater
  const startTs = Date.now();
  const dur = FARM_TIME_MS;
  const iv = setInterval(()=>{
    const pct = Math.min(100, Math.round((Date.now()-startTs)/dur*100));
    popupProgBar.style.width = pct+'%';
    if(pct>=100){
      clearInterval(iv);
      closePopup();
      settleFarm(id);
    }
  }, 1000);
}

/* settleFarm: compute random wins per item (A1 logic), update balances and records */
function settleFarm(id){
  const farms = getStore('farms', []);
  const idx = farms.findIndex(f=>f.id===id);
  if(idx === -1) return;
  const f = farms[idx];
  if(f.status !== 'growing') return;
  const cfg = CROP[f.crop];
  let totalWins = 0;
  const perLotWins = [];
  // For each lot, simulate lotSize independent items with per-item chance
  for(let l=0;l<f.lots;l++){
    let lotWins = 0;
    for(let i=0;i<cfg.lotSize;i++){
      if(Math.random()*100 <= cfg.chance) lotWins++;
    }
    perLotWins.push(lotWins);
    totalWins += lotWins;
  }
  const totalReturn = totalWins * cfg.returnPerItem;
  const profit = totalReturn - f.cost;
  f.status = 'finished';
  f.wins = totalWins;
  f.perLotWins = perLotWins;
  f.profit = profit;
  f.finishedAt = now();
  farms[idx] = f;
  setStore('farms', farms);
  if(firebaseEnabled) writeDoc('farms', f.id, f);

  // Update user balance and stats
  const users = getStore('users', {});
  const me = users[f.owner] || { balance:0, stats:{farms:0,wins:0,profit:0} };
  me.balance = (Number(me.balance) || 0) + Number(totalReturn);
  me.stats = me.stats || {farms:0,wins:0,profit:0};
  me.stats.farms = (me.stats.farms||0) + 1;
  me.stats.wins = (me.stats.wins||0) + totalWins;
  me.stats.profit = (me.stats.profit||0) + profit;
  users[f.owner] = me;
  setStore('users', users);
  if(firebaseEnabled) writeUser(f.owner, me);

  renderHeader(); renderTables();

  // Notify owner
  if(f.owner === currentUser){
    // build per-lot summary
    const lotText = f.perLotWins.map((w, i)=>`Lot ${i+1}: ${w}/${cfg.lotSize} wins ‚Äî Profit: ${formatAmt(w*cfg.returnPerItem - cfg.costPerLot)}`).join('\n');
    const msg = `Farm ID: ${f.id}\nTotal Wins: ${f.wins}\nTotal Profit: ${formatAmt(f.profit)}\n\nPer-Lot:\n${lotText}`;
    openPopup('üåæ Farming Result', `<pre style="white-space:pre-wrap">${msg}</pre>`, `<button class="btn gold" onclick="closePopup()">OK</button>`);
    showMessage(`Farming finished! ${formatAmt(f.profit)}`, f.profit>=0 ? 'success' : 'error');
  } else {
    // if other user, just save
    showMessage('A farm finished (not yours).', 'info');
  }
}

/* Quick farm (small) for testing */
function quickFarm50(){
  // quick farm: cost ‚Çπ50, instant 3s timer, uses tomato's chance
  const cfg = CROP.tomato;
  const lots = 1;
  const cost = 50;9
  const users = getStore('users', {});
  const me = users[currentUser];
  if(me.balance < cost){ showMessage('Insufficient balance!', 'error'); return; }
  me.balance -= cost; users[currentUser]=me; setStore('users', users);
  const id = randomID(); const start = now(); const finish = start + 3000;
  const farm = { id, owner: currentUser, crop:'tomato', cropName:'Tomato', lots, lotSize:5, cost, start, finish, status:'growing' };
  const farms = getStore('farms', []); farms.unshift(farm); setStore('farms', farms);
  renderHeader(); renderTables();

  openPopup('Quick Farm', '<div class="small">Quick farm running...</div>', `<button class="btn" onclick="closePopup()">Minimize</button>`, true);
  setTimeout(()=>{ settleQuickFarm(id); }, 3000);
}
function settleQuickFarm(id){
  // simplified quick settle
  const farms = getStore('farms', []); const idx = farms.findIndex(f=>f.id===id); if(idx===-1) return;
  const f = farms[idx]; if(f.status !== 'growing') return;
  const cfg = CROP.tomato;
  let wins=0;
  for(let i=0;i<f.lotSize;i++) if(Math.random()*100 <= cfg.chance) wins++;
  const totalReturn = wins * cfg.returnPerItem;
  const profit = totalReturn - f.cost;
  f.status='finished'; f.wins=wins; f.profit=profit; f.finishedAt=now();
  farms[idx]=f; setStore('farms', farms);
  const users = getStore('users', {}); const me = users[f.owner];
  me.balance += totalReturn; me.stats.farms += 1; me.stats.wins += wins; me.stats.profit += profit;
  users[f.owner]=me; setStore('users', users);
  renderHeader(); renderTables();
  closePopup();8
  showMessage(`Quick farm finished! ${formatAmt(profit)}`, profit>=0 ? 'success' : 'error');
}

/* ====== Deposit flow ====== */
let depositTimerRef = null;
function startDeposit(){
  const amt = parseInt(document.getElementById('depositAmt').value) || 0;
  if(!amt || amt <= 0){ showMessage('Enter a valid amount!', 'error'); return; }
  if(amt > 20000){ showMessage('‚ùå ‚Çπ20,000 se jyaada transaction allowed nahi hai!', 'error'); return; }

  const upiLink = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=Farm2Earn&am=${amt}&cu=INR`;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(upiLink)}`;

  document.getElementById('upiDisplay').innerText = `${UPI_ID} ‚Ä¢ ‚Çπ${amt}`;
  document.getElementById('qrWrap').innerHTML = `<img src="${qrUrl}" width="200" height="200" alt="QR Code">`;
  document.getElementById('depositFlow').style.display = 'block';
  const doneBtn = document.getElementById('depositDoneBtn');
  doneBtn.disabled = true;

  let timeLeft = 15;
  const countdown = document.getElementById('countdownDisplay');
  countdown.innerText = `Please complete payment within ${timeLeft}s`;

  if(depositTimerRef) clearInterval(depositTimerRef);
  depositTimerRef = setInterval(()=>{
    timeLeft--;
    countdown.innerText = `Please complete payment within ${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(depositTimerRef);
      depositTimerRef = null;
      doneBtn.disabled = false;
      countdown.innerText = "Now press Done after completing payment ‚úÖ";
      showMessage("‚úÖ You can now press Done after payment!", "success");
    }
  }, 1000);
}

function finishDeposit(){
  const amt = parseInt(document.getElementById('depositAmt').value) || 0;
  if(!amt){ showMessage('Invalid amount', 'error'); return; }
  const id = randomID();
  const doc = { id, owner: currentUser, amount: amt, status: 'pending', created: now() };
  const deps = getStore('deposits', []); deps.unshift(doc); setStore('deposits', deps);
  if(firebaseEnabled) writeDoc('deposits', id, doc);

  document.getElementById('depositAmt').value = '';
  document.getElementById('depositFlow').style.display = 'none';
  showMessage('‚úÖ Deposit request sent to admin!', 'success');
  renderTables();
}

/* ====== Withdraw ====== */
function createWithdraw(){
  const amt = Math.max(1, parseInt(document.getElementById('withdrawAmt').value) || 0);
  const note = (document.getElementById('withdrawNote').value || '').trim();
  if(!amt){ showMessage('Enter amount!', 'error'); return; }
  const users = getStore('users', {});
  const me = users[currentUser];
  if(amt < 100) return showMessage('‚ùå Minimum ‚Çπ100 withdraw allowed!', 'error');
  if(amt > 10000) return showMessage('‚ùå ‚Çπ10,000 se jyaada withdraw allowed nahi hai!', 'error');
  if(me.balance < amt) return showMessage('üí∏ Insufficient balance!', 'error');
  if(!note) return showMessage('‚ö†Ô∏è Enter your UPI / Bank details!', 'error');

  // Deduct instantly
  me.balance -= amt; users[currentUser]=me; setStore('users', users);
  document.getElementById('meBal').innerText = formatAmt(me.balance);

  // Create withdraw
  const id = randomID();
  const doc = { id, owner: currentUser, amount: amt, note, status: 'pending', created: now() };
  const arr = getStore('withdraws', []); arr.unshift(doc); setStore('withdraws', arr);
  if(firebaseEnabled) writeDoc('withdraws', id, doc);

  document.getElementById('withdrawAmt').value = '';
  document.getElementById('withdrawNote').value = '';
  renderTables();
  showMessage('‚úÖ Withdraw request submitted (pending admin approval)', 'success');
}

/* ====== Profile ====== */
function saveProfile(){
  const name = (document.getElementById('profileName').value || '').trim();
  const upi = (document.getElementById('profileUPI').value || '').trim();
  if(!name) return showMessage('Enter name', 'error');
  const users = getStore('users', {});
  const me = users[currentUser] || {};
  me.name = name; 
  if(upi) me.upi = upi;
  users[currentUser] = me; setStore('users', users);
  if(firebaseEnabled) writeUser(currentUser, me);
  renderHeader();
  showMessage('Saved', 'success');
}

/* ====== Daily Claim (Coins + Streak) ====== */
function claimDaily() {
  const users = getStore('users', {});
  const me = users[currentUser];

  if (!me.daily) {
    me.daily = { lastClaim: "", streak: 0 };
  }

  const today = new Date().toDateString();
  const last = me.daily.lastClaim || "";

  // Already claimed today
  if (today === last) {
    showMessage("‚òÄÔ∏è Today‚Äôs daily reward already claimed!", "error");
    return;
  }

  let streak = me.daily.streak || 0;

  // If gap more than 1 day ‚Üí streak reset
  if (last !== "" && (new Date(today) - new Date(last) > 86400000)) {
    streak = 0;
  }

  // Increase streak
  streak++;

  // Daily reward coins
  let coinsReward = 5;

  // 7-day bonus
  if (streak === 7) {
    coinsReward += 50;
    streak = 0; // reset streak
    showMessage("üî• 7-Day Bonus Unlocked! +50 Coins", "success");
    // reset UI immediately
    document.getElementById('streakBar').style.width = "0%";
    document.getElementById('streakCount').innerText = 0;
  }

  // Add coins
  me.coins = (me.coins || 0) + coinsReward;

  // Convert coins ‚Üí rupees & add to balance
  const rupeeValue = coinToRupee(coinsReward);
  me.balance = (Number(me.balance) || 0) + rupeeValue;

  // Save daily info
  me.daily = { lastClaim: today, streak };

  users[currentUser] = me;
  setStore('users', users);

  if(firebaseEnabled) writeUser(currentUser, me);

  // Update UI
  renderHeader();

  showMessage(`üéÅ Daily Reward: +${coinsReward} coins (‚Çπ${rupeeValue.toFixed(2)})`, "success");
}

/* ====== Tables rendering ====== */
function renderTables(){
  // farms
  const farms = getStore('farms', []);
  const ft = document.querySelector('#farmsTable tbody');
  ft.innerHTML = '';
  farms.forEach(f=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${f.id}</td><td>${f.cropName||f.crop}</td><td>${f.lots}</td><td>${f.status}</td><td>${formatAmt(f.profit||0)}</td>`;
    ft.appendChild(tr);
  });

  // deposits
  const deps = getStore('deposits', []);
  const dt = document.querySelector('#deposTable tbody');
  dt.innerHTML = '';
  deps.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d.id}</td><td>${formatAmt(d.amount)}</td><td>${d.status}</td>`;
    dt.appendChild(tr);
  });

  // withdraws
  const wds = getStore('withdraws', []);
  const wt = document.querySelector('#withTable tbody');
  wt.innerHTML = '';
  wds.forEach(w=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${w.id}</td><td>${formatAmt(w.amount)}</td><td>${w.status}</td>`;
    wt.appendChild(tr);
  });
}

/* ====== Helpers for firebase writes (safe) ====== */
function writeDoc(collection, id, data){
  if(!firebaseEnabled) return;
  try{ db.collection(collection).doc(id).set(data); } catch(e){ console.warn('writeDoc err', e); }
}
function writeUser(uid, data){
  if(!firebaseEnabled) return;
  try{ db.collection('users').doc(uid).set(data); } catch(e){ console.warn('writeUser err', e); }
}

/* ====== Admin shortcut ====== */
window.addEventListener('keydown', e=>{
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='a'){
    const b = document.getElementById('openAdminHint');
    b.style.display = 'inline-block';
    b.onclick = ()=> window.open('admin.html','_blank');
    b.innerText = 'Open Admin';
  }
});

/* ====== Search filter ====== */
function filterTables(){
  const q = (document.getElementById('searchHistory').value||'').trim().toLowerCase();
  document.querySelectorAll('#farmsTable tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
}

/* ====== Initial render ====== */
renderHeader(); renderTables();
</script>

<!-- Firebase SDK (optional) -->
<!-- If you want Firebase live features, include these scripts when hosting:
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
-->
</body>
</html>

